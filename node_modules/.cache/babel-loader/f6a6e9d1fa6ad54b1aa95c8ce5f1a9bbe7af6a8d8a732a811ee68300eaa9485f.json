{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{apiService}from'../services/apiService.js';import LoadingSpinner from'../components/LoadingSpinner.jsx';import toast from'react-hot-toast';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function Chat(){const[messages,setMessages]=useState([]);const[currentMessage,setCurrentMessage]=useState('');const[conversations,setConversations]=useState([]);const[currentConversation,setCurrentConversation]=useState(null);const[loading,setLoading]=useState(false);const[conversationsLoading,setConversationsLoading]=useState(true);const[chatMode,setChatMode]=useState('rag');// default to RAG mode\nconst messagesEndRef=useRef(null);useEffect(()=>{loadConversations();},[]);useEffect(()=>{scrollToBottom();},[messages]);const scrollToBottom=()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:'smooth'});};const loadConversations=async()=>{try{setConversationsLoading(true);const data=await apiService.getConversations();setConversations(data);if(data.length===0)setChatMode('general');// No docs -> set general mode\n}catch(err){toast.error('Failed to load chat history');}finally{setConversationsLoading(false);}};const loadConversation=async conversationId=>{try{setLoading(true);const messages=await apiService.getConversationMessages(conversationId);setCurrentConversation(conversations.find(c=>c.id===conversationId));setMessages(messages);}catch(err){toast.error('Failed to load conversation');}finally{setLoading(false);}};const sendMessage=async e=>{e.preventDefault();if(!currentMessage.trim()||loading)return;const userMessage=currentMessage.trim();setCurrentMessage('');setLoading(true);const tempMessage={id:\"temp-\".concat(Date.now()),role:'user',content:userMessage,created_at:new Date().toISOString()};setMessages(prev=>[...prev,tempMessage]);try{// Pass chatMode as query param 'mode' to backend\nconst response=await apiService.sendMessage(userMessage,currentConversation===null||currentConversation===void 0?void 0:currentConversation.id,chatMode);setMessages(prev=>prev.filter(msg=>msg.id!==tempMessage.id));const newMessages=[{id:\"user-\".concat(Date.now()),role:'user',content:userMessage,created_at:new Date().toISOString()},{id:\"assistant-\".concat(Date.now()),role:'assistant',content:response.message,sources:response.sources||[],created_at:new Date().toISOString(),context_used:response.context_used}];setMessages(prev=>[...prev,...newMessages]);if(!currentConversation||currentConversation.id!==response.conversation_id){setCurrentConversation({id:response.conversation_id,title:userMessage.substring(0,50)+(userMessage.length>50?'...':'')});await loadConversations();}}catch(err){toast.error('Failed to send message');setMessages(prev=>prev.filter(msg=>msg.id!==tempMessage.id));}finally{setLoading(false);}};const startNewConversation=()=>{setCurrentConversation(null);setMessages([]);};const formatDate=dateString=>{return new Date(dateString).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});};return/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-xl shadow-sm border border-gray-200 h-[calc(100vh-8rem)] flex\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"w-80 border-r border-gray-200 flex flex-col\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 border-b border-gray-200\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-lg font-semibold text-gray-900\",children:\"\\uD83D\\uDCAC Chat History\"}),/*#__PURE__*/_jsx(\"button\",{onClick:startNewConversation,className:\"w-full mt-3 btn-primary\",children:\"\\u2795 New Chat\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 flex space-x-2\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"flex-1 px-3 py-1 rounded \".concat(chatMode==='general'?'bg-primary-600 text-white':'bg-gray-100 text-gray-700'),onClick:()=>setChatMode('general'),children:\"General Chat\"}),/*#__PURE__*/_jsx(\"button\",{className:\"flex-1 px-3 py-1 rounded \".concat(chatMode==='rag'?'bg-primary-600 text-white':'bg-gray-100 text-gray-700',\" \").concat(conversations.length===0?'opacity-50 cursor-not-allowed':''),onClick:()=>conversations.length>0&&setChatMode('rag'),disabled:conversations.length===0,title:conversations.length===0?'Upload documents to enable RAG mode':'',children:\"Document Chat\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 overflow-y-auto\",children:conversationsLoading?/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 text-center\",children:[/*#__PURE__*/_jsx(LoadingSpinner,{size:\"medium\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500 mt-2\",children:\"Loading...\"})]}):conversations.length>0?/*#__PURE__*/_jsx(\"div\",{className:\"p-2\",children:conversations.map(conversation=>/*#__PURE__*/_jsxs(\"div\",{className:\"p-3 mb-2 rounded-lg cursor-pointer transition-colors \".concat((currentConversation===null||currentConversation===void 0?void 0:currentConversation.id)===conversation.id?'bg-primary-50 border-l-4 border-primary-500':'hover:bg-gray-50'),onClick:()=>loadConversation(conversation.id),children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-medium text-gray-900 truncate\",children:conversation.title}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500\",children:formatDate(conversation.created_at)})]},conversation.id))}):/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col items-center justify-center h-full p-4 text-center\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-4xl mb-3\",children:\"\\uD83D\\uDCAC\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500 text-sm\",children:\"No chat history yet\"})]})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1 flex flex-col\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 border-b border-gray-200 bg-gray-50\",children:[/*#__PURE__*/_jsxs(\"h3\",{className:\"text-lg font-semibold text-gray-900 flex items-center\",children:[\"\\u2728 \",currentConversation?currentConversation.title:'AI RAG Chat']}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1 overflow-y-auto p-4 space-y-4\",children:[messages.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col items-center justify-center h-full text-center\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-medium text-gray-900 mb-2\",children:chatMode==='rag'?'Start a RAG conversation':'Start a general chat'}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500 max-w-sm mb-6\",children:chatMode==='rag'?'Ask questions about your uploaded documents.':'Chat freely without document context.'})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[messages.map(message=>/*#__PURE__*/_jsx(\"div\",{className:\"flex \".concat(message.role==='user'?'justify-end':'justify-start'),children:/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-xs lg:max-w-md px-4 py-3 rounded-2xl \".concat(message.role==='user'?'bg-primary-600 text-white ml-auto':'bg-gray-100 text-gray-900'),children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm leading-relaxed whitespace-pre-wrap\",children:message.content}),message.role==='assistant'&&message.context_used&&chatMode==='rag'&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 text-xs text-primary-600 flex items-center\",children:\"\\u2728 Answered using knowledge base\"}),message.role==='assistant'&&message.sources&&message.sources.length>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-3 pt-3 border-t border-gray-200\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-600 mb-2\",children:\"\\uD83D\\uDCC4 Sources:\"}),message.sources.slice(0,2).map((source,index)=>/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-gray-500 bg-gray-50 p-2 rounded mb-1\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"font-medium\",children:source.filename}),source.similarity_score&&/*#__PURE__*/_jsxs(\"div\",{className:\"text-primary-600\",children:[Math.round(source.similarity_score*100),\"% match\"]})]},index))]})]})},message.id)),loading&&/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-start\",children:/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-100 px-4 py-3 rounded-2xl\",children:/*#__PURE__*/_jsx(LoadingSpinner,{size:\"small\"})})})]}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"border-t border-gray-200 p-4 bg-gray-50\",children:[/*#__PURE__*/_jsxs(\"form\",{onSubmit:sendMessage,className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:currentMessage,onChange:e=>setCurrentMessage(e.target.value),placeholder:chatMode==='rag'?\"Ask me anything about your documents...\":\"Chat freely without documents...\",className:\"flex-1 input-field\",disabled:loading}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:loading||!currentMessage.trim(),className:\"btn-primary px-4 disabled:opacity-50\",children:loading?/*#__PURE__*/_jsx(LoadingSpinner,{size:\"small\",color:\"white\"}):'ðŸš€'})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-between mt-2 text-xs text-gray-500\",children:/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83D\\uDCA1 Tip: Upload documents in Knowledge Base to get better answers\"})})]})]})]});}export default Chat;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}